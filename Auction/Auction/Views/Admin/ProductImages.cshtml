@model List<Auction.Models.image>
@{
    ViewBag.Title = "ProductImages";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}
<div id="mainDiv">
    <style>
        .img {
            padding: 3px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            width: 184px;
            height: 160px;
            object-fit: cover;
        }

        .deleteBtn {
            background: #e91e63;
            border: none;
            color: white;
            border-color: #e91e63;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .setImageBtn {
            background: #e91e63;
            border: none;
            color: white;
            border-color: #e91e63;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .selected_btn {
            border: none;
            color: white;
            border-color: #e91e63;
            border-radius: 5px;
            margin: 0px;
            font-size: 10px;
            padding: 1.5px 5px;
            font-weight: bold;
        }

        #image_error {
            color: red;
            font-size: 15px;
            font-weight: 500;
            padding: 0px;
            margin: 0px;
        }
    </style>
    <h2 class="text-center">Product Images</h2>

    <div class="content-wrapper p-5">
        <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <div class="col-md-4 w-auto p-0" style="margin:0px 5px;">
                            <div id="imageFormDiv">
                                <button id="AddNewBtn" style="padding: 10px 26px;" class="btn btn-primary" type="button">Add New Image</button>
                                <button id="cancelBtn" style="padding: 10px 26px;" class="btn btn-primary" type="button">Cancel</button>
                                <form enctype="multipart/form-data" id="imgForm" style="display:none;">
                                    <label>Add New Image</label>
                                    <input type="file" id="ImageFile" class="form-control" name="ImageFile" value="" />
                                    <input type="hidden" name="ImageFilePath" id="ImageFilePath" value="" />
                                    <p style="color:red;" id="image_error">&nbsp;</p>
                                    <input type="button" class="btn btn-primary" id="addBtn" value="Add Image" />
                                    <input type="button" class="btn btn-primary" id="cancel_Btn" value="Cancel" />
                                </form>
                            </div>
                            <div class="card-body px-0 pb-2 pt-0">
                                <div class="table-responsive p-0">
                                    <table class="table text-center align-items-center mb-0">
                                        <thead>
                                            <tr>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"><span style="font-size:13px;">Sno</span></th>
                                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"><span style="font-size:13px;">Image</span></th>
                                                <th class="text-secondary opacity-7"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (Model != null && Model.Count() > 0)
                                            {
                                                int sno = 1;

                                                foreach (var item in Model)
                                                {
                                                    if (sno == 1)
                                                    {
                                                        <tr style="display:none;">
                                                            <td>
                                                                <input type="hidden" id="p_id" value="@ViewBag.pid" />
                                                            </td>
                                                        </tr>
                                                    }
                                                    if (item.img_selected == 1)
                                                    {
                                                        <tr style="background-color:lightcyan;border-radius:10px;">
                                                            <td>
                                                                <p class="text-md font-weight-bold mb-0">@(sno++)</p>
                                                            </td>
                                                            <td>
                                                                <p class="text-xs font-weight-bold mb-0">
                                                                    <img src="@Url.Content(item.img_text)" class="img img-fluid" alt="Image" id="ProductImage" />
                                                                </p>
                                                            </td>
                                                            <td>
                                                                <p class="text-xs font-weight-bold mb-0">
                                                                    <button class="deleteBtn" data-id="@item.img_id">
                                                                        Delete
                                                                    </button>

                                                                    @if (item.img_selected == 1)
                                                                    {
                                                                        <button class="btn btn-info selected_btn" data-id="@item.img_id">
                                                                            Selected
                                                                        </button>
                                                                    }
                                                                    else
                                                                    {
                                                                        <button class="setImageBtn" data-id="@item.img_id">
                                                                            Set Image
                                                                        </button>
                                                                    }
                                                                </p>
                                                            </td>
                                                        </tr>
                                                    }
                                                    else
                                                    {
                                                        <tr>
                                                            <td>
                                                                <p class="text-md font-weight-bold mb-0">@(sno++)</p>
                                                            </td>
                                                            <td>
                                                                <p class="text-xs font-weight-bold mb-0">
                                                                    <img src="@Url.Content(item.img_text)" class="img img-fluid" alt="Image" id="ProductImage" />
                                                                </p>
                                                            </td>
                                                            <td>
                                                                <p class="text-xs font-weight-bold mb-0">
                                                                    <button class="deleteBtn" data-id="@item.img_id">
                                                                        Delete
                                                                    </button>

                                                                    @if (item.img_selected == 1)
                                                                    {
                                                                        <button class="btn btn-info selected_btn" data-id="@item.img_id">
                                                                            Selected
                                                                        </button>
                                                                    }
                                                                    else
                                                                    {
                                                                        <button class="setImageBtn" data-id="@item.img_id">
                                                                            Set Image
                                                                        </button>
                                                                    }
                                                                </p>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="6" style="padding-top:32px;" class="text-danger text-center font-weight-bold">
                                                        No Image found
                                                        <input type="hidden" id="p_id" value="@ViewBag.pid" />
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    $("#AddNewBtn").click(function () {
        $("#imgForm").show();
        $("#cancelBtn").hide();
        $(this).hide();
    });

    $("#cancel_Btn").click(function () {
        $("#image_error").html("&nbsp;");
        $("#imgForm").hide();
        $("#AddNewBtn").show();
        $("#cancelBtn").show();
        $("#ImageFile").val("");
    });

     $("#ImageFile").change(function () {
     $("#image_error").html("&nbsp;");
        var element = this;

        var formData = new FormData();

        var totalFiles = element.files.length;

        for (var i = 0; i < totalFiles; i++) {
            var file = element.files[i];
            formData.append("Photo", file);
        }

        $.ajax({
            type: 'POST',
            url: '@Url.Action("UploadImage", "Shared")',
            dataType: 'json',
            data: formData,
            contentType: false,
            processData: false
        })
            .done(function (response) {
                if (response.Success == true) {
                    $("#image_error").html("&nbsp;");
                    $("#ImageFilePath").val(response.ImageURL)
                } else if (response.Success == false){
                    $("#image_error").show();
                    $("#image_error").html(response.Error);
                }
            })
            .fail(function (XMLHttpRequest, textStatus, errorThrown) {
                alert("FAIL");
            });
    });

    $("#addBtn").click(function () {
        $("#image_error").html("&nbsp;");
        if ($("#ImageFile").val() == "" || $("#ImageFile").val() == undefined) {
            $("#image_error").html("Image is required");
        }
        else
        {
            var fup = document.getElementById('ImageFile');
            var fileName = fup.value;
            var ext = fileName.substring(fileName.lastIndexOf('.') + 1);
            if (ext == "png" || ext == "jpg" || ext == "jpeg") {
                $.ajax({
                    url: '@Url.Action("AddProductImage", "Admin")',
                    type: 'post',
                    data: {
                        img: $("#ImageFilePath").val(),
                        id: parseInt($("#p_id").val()),
                        pageNo: "@TempData["pageNo"]",
                        search: "@TempData["search"]"
                    },
                })
                    .done(function (response) {
                        if (response == "no") {
                            $("#image_error").html("Image Already exist");
                        } else {
                            $("#mainDiv").html(response);
                        }
                    })
                    .fail(function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("FAIL");
                    });

            } else {
                $("#image_error").html("Image Format not Supported");
            }
        }
        });

        $(".deleteBtn").click(function () {
            swal({
                title: "Are you sure?",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {

        $.ajax({
            url: '@Url.Action("DeleteProductImage", "Admin")',
            type: 'post',
            data: {
                img_id: $(this).attr('data-id'),
                pageNo: "@TempData["pageNo"]",
                search: "@TempData["search"]"
            }
        })
            .done(function (response) {
                $("#mainDiv").html(response);
                swal("Deleted Successfully!", {
                    icon: "success",
                });
            })
            .fail(function (XMLHttpRequest, textStatus, errorThrown) {
                alert("FAIL");
                    });

            }
        });
        });

        $("#cancelBtn").click(function () {
            debugger;
            $.ajax({
                url: '@Url.Action("ProductTable", "Admin")',
                data: {
                    pageNo: "@TempData["pageNo"]",
                    search: "@TempData["search"]"
                }
            })
                .done(function (response) {
                    $("#tableContainer").html(response);
                    $("#actionContainer").html("");
                })
                .fail(function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("FAIL");
                });
        });

        $(".setImageBtn").click(function () {
            $.ajax({
                url: '@Url.Action("SetProductImage", "Admin")',
                type:'post',
                data: {
                    img_id: $(this).attr('data-id'),
                    pageNo: "@TempData["pageNo"]",
                    search: "@TempData["search"]"
                }
            })
                .done(function (response) {
                    $("#tableContainer").html(response);
                    $("#actionContainer").html("");
                })
                .fail(function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("FAIL");
                });
        });
    </script>
</div>